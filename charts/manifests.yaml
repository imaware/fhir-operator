---
# Source: fhir-operator/templates/rbac.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  annotations:
    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
    kubernetes.io/description: >-
      This policy grants the minimum amount of privilege necessary to run
      non-privileged kube-system pods. This policy is not intended for use
      outside of kube-system, and may include further restrictions in the
      future.
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'runtime/default,docker/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default
  labels:
    app.kubernetes.io/instance: fhir-manager
  name: fhir-operator.psp
spec:
  allowPrivilegeEscalation: false
  allowedCapabilities: []
  fsGroup:
    rule: RunAsAny
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
    - emptyDir
    - csi
    - configMap
    - secret
    - projected
    - downwardAPI
---
# Source: fhir-operator/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fhir-operator
  namespace: ethan-test
  labels:
    helm.sh/chart: fhir-operator-0.1.0
    app.kubernetes.io/name: fhir-operator
    app.kubernetes.io/app: fhir-operator
    app.kubernetes.io/instance: fhir-operator
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    iam.gke.io/gcp-service-account: fhir-operator@imaware-test.iam.gserviceaccount.com
---
# Source: fhir-operator/templates/crd/fhir.imaware.com_fhirresources.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.7.0
  creationTimestamp: null
  name: fhirresources.fhir.imaware.com
spec:
  group: fhir.imaware.com
  names:
    kind: FhirResource
    listKind: FhirResourceList
    plural: fhirresources
    singular: fhirresource
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: FhirResource is the Schema for the fhirresources API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: FhirResourceSpec defines the desired state of FhirResource
            properties:
              representation:
                description: The representation of the FHIR resource in JSON format
                type: string
              resourceType:
                description: Type this points to the type of the FHIR resource such
                  as ObservationDefinition
                type: string
              selector:
                description: The FhirStore that the resource will be applied to by
                  the selector
                properties:
                  name:
                    description: The FhirStore resource name to select for the resource
                    type: string
                required:
                - name
                type: object
            required:
            - representation
            - resourceType
            - selector
            type: object
          status:
            description: FhirResourceStatus defines the observed state of FhirResource
            properties:
              Message:
                type: string
              Status:
                description: 'INSERT ADDITIONAL STATUS FIELD - define observed state
                  of cluster Important: Run "make" to regenerate code after modifying
                  this file'
                type: string
            required:
            - Message
            - Status
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: []
  storedVersions: []
---
# Source: fhir-operator/templates/crd/fhir.imaware.com_fhirstores.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.7.0
  creationTimestamp: null
  name: fhirstores.fhir.imaware.com
spec:
  group: fhir.imaware.com
  names:
    kind: FhirStore
    listKind: FhirStoreList
    plural: fhirstores
    singular: fhirstore
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: FhirStore is the Schema for the fhirstores API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: FhirStoreSpec defines the desired state of FhirStore
            properties:
              auth:
                additionalProperties:
                  description: FhirStoreSpecAuthSpec defines what service accounts
                    can talk to the fhir API
                  properties:
                    members:
                      items:
                        type: string
                      type: array
                  required:
                  - members
                  type: object
                description: auth defines who has access to the fhir API. Key is the
                  role and each key has a members which contains a list of members
                type: object
              datasetID:
                description: datasetID is the name of the dataset the fhirstore will
                  be put in
                type: string
              fhirStoreID:
                description: fhirStoreID is the name that the fhir store will be called
                type: string
              options:
                description: options Options to be enabled on the fhir store
                properties:
                  enableUpdateCreate:
                    description: enableUpdateCreate enables or disables the create
                      on update option for the fhir store
                    type: boolean
                  preventDelete:
                    description: preventDelete option to prevent the fhir store from
                      being deleted if set to true. This will also prevent the resource
                      from being deleted unless removed
                    type: boolean
                required:
                - enableUpdateCreate
                - preventDelete
                type: object
            required:
            - datasetID
            - fhirStoreID
            type: object
          status:
            description: FhirStoreStatus defines the observed state of FhirStore
            properties:
              Message:
                type: string
              Status:
                description: 'INSERT ADDITIONAL STATUS FIELD - define observed state
                  of cluster Important: Run "make" to regenerate code after modifying
                  this file'
                type: string
            required:
            - Message
            - Status
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: []
  storedVersions: []
---
# Source: fhir-operator/templates/crd/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: fhir-operator
rules:
- apiGroups:
  - fhir.imaware.com
  resources:
  - fhirresources
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - fhir.imaware.com
  resources:
  - fhirresources/finalizers
  verbs:
  - update
- apiGroups:
  - fhir.imaware.com
  resources:
  - fhirresources/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - fhir.imaware.com
  resources:
  - fhirstores
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - fhir.imaware.com
  resources:
  - fhirstores/finalizers
  verbs:
  - update
- apiGroups:
  - fhir.imaware.com
  resources:
  - fhirstores/status
  verbs:
  - get
  - patch
  - update
---
# Source: fhir-operator/templates/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: fhir-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: fhir-operator
subjects:
- kind: ServiceAccount
  name: fhir-operator
  namespace: ethan-test
---
# Source: fhir-operator/templates/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: fhir-operator
  namespace: ethan-test
rules:
  - apiGroups:
      - policy
    resourceNames:
      - fhir-operator.psp
    resources:
      - podsecuritypolicies
    verbs:
      - use
---
# Source: fhir-operator/templates/rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: fhir-operator
  namespace: ethan-test
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name:  fhir-operator
subjects:
  - kind: ServiceAccount
    name: fhir-operator
---
# Source: fhir-operator/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fhir-operator
  labels:
    helm.sh/chart: fhir-operator-0.1.0
    app.kubernetes.io/name: fhir-operator
    app.kubernetes.io/app: fhir-operator
    app.kubernetes.io/instance: fhir-operator
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  namespace: ethan-test
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: fhir-operator
      app.kubernetes.io/app: fhir-operator
      app.kubernetes.io/instance: fhir-operator
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: fhir-operator
        app.kubernetes.io/app: fhir-operator
        app.kubernetes.io/instance: fhir-operator
    spec:
      securityContext:
        runAsNonRoot: true
      serviceAccountName: fhir-operator
      containers:
      - env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /var/secrets/google/key.json
          - name: DEBUG_ENABLED
            value: "true"
          - name: GCP_LOCATION
            value: "us-central1"
          - name: GCP_PROJECT
            value: "imaware-test"
        command:
        - /manager
        image: "gcr.io/imaware-test/fhir-operator:1.0.0"
        imagePullPolicy: Always
        name: fhir-operator
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
            limits:
              cpu: 250m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 256Mi
        volumeMounts:
        - mountPath: /var/secrets/google
          name: google-cloud-key
      terminationGracePeriodSeconds: 10
      volumes:
        - name: google-cloud-key
          secret:
            secretName: fhir-operator-key
---
# Source: fhir-operator/templates/serviceaccount.yaml
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: fhir-operator-pm0
  namespace: ethan-test
spec:
  member: serviceAccount:fhir-operator@imaware-test.iam.gserviceaccount.com
  role: roles/healthcare.fhirResourceEditor
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: project/imaware-test
---
# Source: fhir-operator/templates/serviceaccount.yaml
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: fhir-operator-pm1
  namespace: ethan-test
spec:
  member: serviceAccount:fhir-operator@imaware-test.iam.gserviceaccount.com
  role: roles/healthcare.fhirStoreAdmin
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: project/imaware-test
---
# Source: fhir-operator/templates/serviceaccount.yaml
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: fhir-operator-pm2
  namespace: ethan-test
spec:
  member: serviceAccount:fhir-operator@imaware-test.iam.gserviceaccount.com
  role: roles/iam.workloadIdentityUser
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    external: project/imaware-test
---
# Source: fhir-operator/templates/serviceaccount.yaml
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMServiceAccount
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: imaware-test
  name: fhir-operator
  namespace: ethan-test
spec:
  displayName: Service account for fhir-operator
---
# Source: fhir-operator/templates/serviceaccount.yaml
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMServiceAccountKey
metadata:
  namespace: ethan-test
  name: fhir-operator-key
spec:
  publicKeyType: TYPE_X509_PEM_FILE
  keyAlgorithm: KEY_ALG_RSA_2048
  privateKeyType: TYPE_GOOGLE_CREDENTIALS_FILE
  serviceAccountRef:
    name: fhir-operator
